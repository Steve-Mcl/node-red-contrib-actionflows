<script type="text/javascript">
	RED.nodes.registerType('actionflows', {
		category: 'advanced',
		color: '#E0C67E',
		defaults: {
      info: {value: "Describe your action API here."},
      untilproptype: {value: "num"},
      proptype: {value: "msg"},
      name: {value: "action"},
      prop: {value: "loop"},
      untilprop: {value: 0},
      until: {value: "gt"},
      loop: {value: "none"},
      perf: {value: false},
      private: {value: false}
		},
		inputs:1,
		outputs:1,
    icon: function() {
      if (this.loop == 'none' || typeof this.loop == 'undefined') {
        if (this.private) {
          return "actionflows-locked.png";
        }else{
          return "actionflows.png";
        }
      }else{
        if (this.private) {
          return "loopflow-locked.png";
        }else{
          return "loopflow.png";
        }
      }
    },
    paletteLabel: "action",
		label: function() {
      if (this.loop == 'none') {
        if (this.private) {
          this._def.icon = "actionflows-locked.png";
        }else{
          this._def.icon = "actionflows.png";
        }
      }else{
        if (this.private) {
          this._def.icon = "loopflow-locked.png";
        }else{
          this._def.icon = "loopflow.png";
        }
      }
			return this.name||"action";
		},
    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
    info: function() {
        return (this.name?"# "+this.name+"\n":"")+(this.info||"");
    },
    oneditprepare: function() {
      this.editor = RED.editor.createEditor({
          id: 'node-description-editor',
          mode: 'ace/mode/markdown',
          value: $("#node-input-info").val()
      });

      // Support looping
      $('#node-input-prop').typedInput({
        typeField: $("#node-input-proptype"),
        types:['flow','global','msg'],
        default: 'msg'
      });
      $('#node-input-untilprop').typedInput({
        types:['flow','global','msg','str','num','bool'],
        typeField: $("#node-input-untilproptype"),
        default: 'num'
      });
      setTimeout(function() { // typedInput paint refresh bug
        $('#node-input-loop').change(function(){
          if ($(this).val() == 'none') {
            $('.af-loop').hide();
          }else{
            $('.af-loop').show();
          }
        });
        if ($("#node-input-loop").val() == "none") {
          $('.af-loop').hide();
        }else{
          $('.af-loop').show();
        }
      }, 1);
    },
    oneditsave: function() {
      var node = this;
      $("#node-input-info").val(this.editor.getValue());
      this.editor.destroy();
      delete node.editor;
    },
    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    }
	});
</script>
<script type="text/javascript">
	RED.nodes.registerType('actionflows_in', {
		category: 'advanced',
		color: '#E0C67E',
		defaults: {
      name: {value:"action in"},
      priority: {value:"50", required:true, validate:RED.validators.number()},
      links: {value: []},
      private: {value: true}
		},
		inputs:0,
		outputs:1,
		icon: "actionflows-locked.png",
    paletteLabel: "action in",
		label: function() {
      if (this.private) {
        this._def.icon = "actionflows-locked.png";
      }else{
        this._def.icon = "actionflows.png";
      }
			return this.name||"action in";
		},
    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {
      var node = this;
      $("#node-input-priority").spinner({min:1,max:100});
    }
	});
</script>
<script type="text/javascript">
	RED.nodes.registerType('actionflows_out', {
		category: 'advanced',
		color: '#E0C67E',
    align: 'right',
		defaults: {
      name: {value:"action out"},
      links: { value: [] }
		},
		inputs:1,
		outputs:0,
		icon: "actionflows.png",
    paletteLabel: "action out",
		label: function() {
			return this.name||"action out";
		},
    labelStyle: function() {
      return this.name?"node_label_italic":"";
    }
	});
</script>
<script type="text/x-red" data-template-name="actionflows">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label><i class="fa fa-rotate-right"></i> <span>Looping</span></label>
        <select id="node-input-loop" style="width:26%; margin-right:10px;">
          <option value="none">none</option>
          <option value="watch">watch</option>
          <option value="dec">decrement</option>
          <option value="inc">increment</option>
          <option value="inc0">inc. from zero</option>
        </select>
        <div class="af-loop" style="display:inline;">
          <input type="text" id="node-input-prop" style="width:40%;">
          <input type="hidden" id="node-input-proptype"><br/>
        </div>
    </div>
    <div class="form-row af-loop">
      <label style="text-align:right;"><span style="margin-right:3px;">Until</span></label>
      <select id="node-input-until" style="width:26%; margin-right:10px;">
        <option value="eq">==</option>
        <option value="neq">!=</option>
        <option value="lt">&lt;</option>
        <option value="lte">&lt;=</option>
        <option value="gt">&gt;</option>
        <option value="gte">&gt;=</option>
        <option value="cont">contains</option>
        <option value="notc">not contains</option>
      </select>
      <input type="text" id="node-input-untilprop" style="width:40%;">
      <input type="hidden" id="node-input-untilproptype"><br/>
    </div>
    <div class="form-row" style="margin-bottom: 0px;">
      <label for="node-input-info">Description</label>
      <a href="https://guides.github.com/features/mastering-markdown/" target="_blank" style="font-size: 0.8em; float: right;">markdown</a>
      <input type="hidden" id="node-input-info" autofocus="autofocus">
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-description-editor"></div>
    </div>
    <div class="form-row" id="node-action-private">
        <input type="checkbox" id="node-input-private" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-private" style="width: 70%;">
          <span>Private action; invoke flows only on this tab.</span>
        </label>
    </div>
    <div class="form-row" id="node-action-perf">
        <input type="checkbox" id="node-input-perf" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-perf" style="width: 70%;">
          <span>Debug action cycle execution time?</span>
        </label>
    </div>
</script>
<script type="text/x-red" data-template-name="actionflows_in">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row" id="priority-details-for">
        <label for="node-input-priority"><i class="fa fa-flag"></i> Priority</label>
        <input type="text" id="node-input-priority" style="text-align:end; width:50px !important">
    </div>
    <div class="form-row" id="node-actionin-private">
        <input type="checkbox" id="node-input-private" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-private" style="width: 70%;">
          <span>Private flow; only invoked by actions on this tab.</span>
        </label>
    </div>
</script>
<script type="text/x-red" data-template-name="actionflows_out">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>
<script type="text/x-red" data-help-name="actionflows"></script>
<script type="text/x-red" data-help-name="actionflows_in">
  <p>Use the ActionFlows <code>in</code> node to define the start
  of a flow segment.</p>
  <h4>Name</h4>
  <p>Name the node with a prefix that matches the name of an existing
  <code>action</code> node. Use a space, underscore, hyphen or period
  to separate the prefix from your segment&#39;s own unique name/description.
  </p>
  <h4>Priority</h4>
  <p>Use the priority field to determine the priority order for the flow segment.
  The flow segment with the lowest priority number will execute sooner than seqments
  with higher numbers (0 to 99). It is recommend that you leave the default (50)
  if execution order is not required. I.e. two flows with the same name will
  will execute in priority order sequence; 45 will execute before 50, etc.</p>

  <h3>References</h3>
  <ul>
       <li>The official <a href="https://github.com/Steveorevo/node-red-contrib-actionflows" target=_blank>node-red-contrib-actionflows</a> project on GitHub.</li>
   </ul>
</script>
<script type="text/x-red" data-help-name="actionflows_out">
  <p>Use the ActionFlows <code>out</code> node to define the end of a flow
  segment.</p>
  <h4>Name</h4>
  <p>Name the node with a prefix that matches the name of an existing
  <code>in</code> node or <code>action</code> node. Use a space, underscore,
  hyphen or period to separate the prefix from your segment&#39;s own unique
  name/description. A flow that reaches the <code>out</code> node resumes
  execution at the original matching <code>action</code> node.
  </p>
  <h3>References</h3>
  <ul>
       <li>The official <a href="https://github.com/Steveorevo/node-red-contrib-actionflows" target=_blank>node-red-contrib-actionflows</a> project on GitHub.</li>
   </ul>
</script>
